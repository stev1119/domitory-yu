<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ìˆ™ì‚¬ ì¸ì›ë³´ê³ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-card.current { border-left: 5px solid #10b981; }
        .stat-card.out { border-left: 5px solid #f59e0b; }
        .stat-card.new { border-left: 5px solid #3b82f6; }
        .stat-card.move-out { border-left: 5px solid #ef4444; }
        .stat-card.move-in { border-left: 5px solid #8b5cf6; }
        .stat-card.absent { border-left: 5px solid #6b7280; }
        .stat-card.etc { border-left: 5px solid #f97316; }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-card input {
            background: none;
            border: none;
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            width: 100%;
            outline: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-group select {
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
            outline: none;
        }

        .control-group select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .students-section {
            margin-top: 30px;
        }

        .students-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            border-radius: 10px;
        }

        .students-grid {
            display: grid;
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: 100px 1fr 150px 150px 1fr;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .room-number {
            font-weight: 700;
            font-size: 1.1rem;
            color: #4f46e5;
            text-align: center;
            padding: 8px;
            background: linear-gradient(135deg, #eef2ff, #e0e7ff);
            border-radius: 8px;
        }

        .student-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .student-status select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            outline: none;
            transition: all 0.3s ease;
        }

        .student-status select:focus {
            border-color: #4f46e5;
        }

        .student-memo input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
        }

        .student-memo input:focus {
            border-color: #4f46e5;
        }

        .submit-section {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 15px;
            text-align: center;
        }

        .submit-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }

            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }

            .student-card {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .students-grid {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ê¸°ìˆ™ì‚¬ ì¸ì›ë³´ê³ </h1>
            <p>ì‹¤ì‹œê°„ ì¸ì› í˜„í™© ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        </div>

        <div class="main-content">
            <!-- ì¸ì› í˜„í™© ì¹´ë“œ -->
            <div class="stats-grid">
                <div class="stat-card current">
                    <h3>í˜„ì¬ì›</h3>
                    <input type="number" id="current-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card out">
                    <h3>ì™¸ë°•</h3>
                    <input type="number" id="out-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card new">
                    <h3>ì‹ ê·œ</h3>
                    <input type="number" id="new-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card move-out">
                    <h3>ì´ë™-</h3>
                    <input type="number" id="move-out-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card move-in">
                    <h3>ì´ë™+</h3>
                    <input type="number" id="move-in-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card absent">
                    <h3>ë“±ë¯¸</h3>
                    <input type="number" id="absent-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card etc">
                    <h3>í‡´ì†Œ</h3>
                    <input type="number" id="etc-count" class="number" value="0" min="0">
                </div>
            </div>

            <!-- ì„ íƒ ì»¨íŠ¸ë¡¤ -->
            <div class="controls">
                <div class="control-group">
                    <label>ë‹´ë‹¹ì</label>
                    <select id="manager-select">
                        <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
                        <option value="ì´ì˜ìš´">ì´ì˜ìš´</option>
                        <option value="ê¹€í˜œì •">ê¹€í˜œì •</option>
                        <option value="ì´ì‹œìš°">ì´ì‹œìš°</option>
                        <option value="ê³ ìŠ¹ì™„">ê³ ìŠ¹ì™„</option>
                        <option value="ë‚¨ì¸ë‹¬">ë‚¨ì¸ë‹¬</option>
                        <option value="ì¡°ì˜ê¶Œ">ì¡°ì˜ê¶Œ</option>
                        <option value="í™©ë¯¼ì² ">í™©ë¯¼ì² </option>
                        <option value="ê¹€ê±´í¬">ê¹€ê±´í¬</option>
                        <option value="ê°•ì§€í›ˆ">ê°•ì§€í›ˆ</option>
                        <option value="ì†¡ì¸ìˆ˜">ì†¡ì¸ìˆ˜</option>
                        <option value="ê¹€ì˜í˜„">ê¹€ì˜í˜„</option>
                        <option value="ì´ìƒë¯¼">ì´ìƒë¯¼</option>
                        <option value="ë‚˜ì •ìš°">ë‚˜ì •ìš°</option>
                        <option value="í™ì„±ëª¨">í™ì„±ëª¨</option>
                        <option value="ì§„ì •í˜„">ì§„ì •í˜„</option>
                        <option value="ì›í˜„ì£¼">ì›í˜„ì£¼</option>
                        <option value="ê¹€ì •ì•„">ê¹€ì •ì•„</option>
                        <option value="ê¹€ì§€í˜„">ê¹€ì§€í˜„</option>
                        <option value="ê¹€ë¯¸ê²½">ê¹€ë¯¸ê²½</option>
                        <option value="ìœ ë‚˜ê²½">ìœ ë‚˜ê²½</option>
                        <option value="ì‹ ê·œ1">ì‹ ê·œ1</option>
                        <option value="ì‹ ê·œ2">ì‹ ê·œ2</option>
                        <option value="ì‹ ê·œ3">ì‹ ê·œ3</option>
                        <option value="ì‹ ê·œ4">ì‹ ê·œ4</option>
                        <option value="ì‹ ê·œ5">ì‹ ê·œ5</option>
                        <option value="ì‹ ê·œ6">ì‹ ê·œ6</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ë™</label>
                    <select id="building-select">
                        <option value="">ë™ ì„ íƒ</option>
                        <option value="A">Aë™ (ë‚¨í•™ìƒ)</option>
                        <option value="B">Bë™ (ë‚¨í•™ìƒ)</option>
                        <option value="C">Cë™ (ë‚¨í•™ìƒ)</option>
                        <option value="D">Dë™ (ì—¬í•™ìƒ)</option>
                        <option value="E">Eë™ (ì—¬í•™ìƒ)</option>
                        <option value="F">Fë™ (ë‚¨í•™ìƒ)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ì¸µ</label>
                    <select id="floor-select">
                        <option value="">ì¸µ ì„ íƒ</option>
                        <option value="1">1ì¸µ (1ì¸ì‹¤)</option>
                        <option value="2">2ì¸µ (1ì¸ì‹¤)</option>
                        <option value="3">3ì¸µ (1ì¸ì‹¤)</option>
                        <option value="4">4ì¸µ (3ì¸ì‹¤)</option>
                    </select>
                </div>
            </div>

            <!-- í•™ìƒ ì •ë³´ ì„¹ì…˜ -->
            <div class="students-section" id="students-section" style="display: none;">
                <div class="students-header">
                    <h3>í•™ìƒ í˜„í™©</h3>
                    <span id="selected-info"></span>
                </div>
                <div class="students-grid" id="students-grid">
                    <!-- í•™ìƒ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì œì¶œ ì„¹ì…˜ -->
            <div class="submit-section">
                <div class="submit-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-modification">
                        <label for="is-modification">ìˆ˜ì •ë³´ê³ </label>
                    </div>
                </div>
                <button class="submit-btn" id="submit-btn" onclick="submitReport()">
                    ğŸ“‹ ì¸ì›ë³´ê³  ì œì¶œ
                </button>
            </div>

            <!-- ë¡œë”© ë° ë©”ì‹œì§€ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ì²˜ë¦¬ ì¤‘...</p>
            </div>
            <div class="message" id="message"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let sheetsData = [];
        let currentStudents = [];
        let lastReportDate = {};

        // ê¸°ìˆ™ì‚¬ í˜¸ì‹¤ ë²”ìœ„ ì •ì˜
        const dormitoryRanges = {
            'A': {
                '1': { start: 101, end: 160 },
                '2': { start: 201, end: 262 },
                '3': { start: 301, end: 362 },
                '4': { start: 401, end: 432 }
            },
            'B': {
                '1': { start: 101, end: 140 },
                '2': { start: 201, end: 241 },
                '3': { start: 301, end: 341 },
                '4': { start: 401, end: 421 }
            },
            'C': {
                '1': { start: 101, end: 161 },
                '2': { start: 201, end: 262 },
                '3': { start: 301, end: 362 },
                '4': { start: 401, end: 432 }
            },
            'D': {
                '1': { start: 101, end: 144 },
                '2': { start: 201, end: 245 },
                '3': { start: 301, end: 345 },
                '4': { start: 401, end: 423 }
            },
            'E': {
                '1': { start: 101, end: 176 },
                '2': { start: 201, end: 278 },
                '3': { start: 301, end: 378 },
                '4': { start: 401, end: 440 }
            },
            'F': {
                '1': { start: 101, end: 132 },
                '2': { start: 201, end: 233 },
                '3': { start: 301, end: 333 },
                '4': { start: 401, end: 417 }
            }
        };

        // êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (B3ë¶€í„° ì‹œì‘)
        async function loadSheetsData() {
            try {
                showLoading(true);
                
                // B3:P1000 ë²”ìœ„ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/values/yulee!B3:P1000?key=AIzaSyAAaDiNQC3o779j_4pzVC4ouuZr48Y-PbY`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('B3:P1000 ë²”ìœ„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ë°ì´í„° í˜•ì‹ ë³€í™˜ (ì¸ë±ìŠ¤ ì—´ ì¶”ê°€)
                sheetsData = [];
                
                // í—¤ë” (B3 í–‰)
                sheetsData.push(['ì¸ë±ìŠ¤'].concat(data.values[0]));
                
                // ë°ì´í„° (B4ë¶€í„°)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    if (row && row.length > 0) {
                        sheetsData.push([i + 3].concat(row)); // ì‹¤ì œ ì‹œíŠ¸ í–‰ ë²ˆí˜¸
                    }
                }
                
                console.log('ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', sheetsData.length, 'í–‰ (í—¤ë” í¬í•¨)');
                showLoading(false);
                
            } catch (error) {
                console.error('ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ì„ íƒëœ ë™/ì¸µì˜ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê°œì„ ëœ ë²„ì „)
        function getStudentsByFloor(building, floor) {
            if (!building || !floor || !dormitoryRanges[building] || !dormitoryRanges[building][floor]) {
                console.error('ì˜ëª»ëœ ë™/ì¸µ ì„ íƒ:', building, floor);
                return [];
            }

            console.log(`${building}ë™ ${floor}ì¸µ í•™ìƒ ë°ì´í„° ë¡œë“œ ì¤‘...`);

            const range = dormitoryRanges[building][floor];
            const students = [];

            // í˜¸ì‹¤ ë²”ìœ„ ë‚´ì˜ ëª¨ë“  í˜¸ì‹¤ ì²˜ë¦¬
            for (let roomNum = range.start; roomNum <= range.end; roomNum++) {
                const roomCode = `${building}${roomNum}`;
                
                // ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í˜¸ì‹¤ ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
                const studentRows = sheetsData.filter((row, index) => {
                    if (index === 0) return false; // í—¤ë” ì œì™¸
                    const sheetRoom = row[1] ? row[1].toString().toUpperCase() : '';
                    return sheetRoom === roomCode.toUpperCase();
                });

                if (studentRows.length > 0) {
                    // í•´ë‹¹ í˜¸ì‹¤ì˜ ëª¨ë“  í•™ìƒ ì¶”ê°€ (3ì¸ì‹¤ ëŒ€ì‘)
                    studentRows.forEach(studentRow => {
                        const rowIndex = sheetsData.findIndex(r => r[0] === studentRow[0]);
                        students.push({
                            room: studentRow[1] || roomCode,
                            name: studentRow[2] || 'ë¯¸ë°°ì •',
                            status: studentRow[3] || 'ì •ìƒ',
                            date: studentRow[4] || '',
                            memo: studentRow[5] || '',
                            sheetRow: sheetRow
                        });
                    });
                } else {
                    // ì‹œíŠ¸ì— ì—†ëŠ” í˜¸ì‹¤ì€ ë¯¸ë°°ì •ìœ¼ë¡œ ì¶”ê°€
                    students.push({
                        room: roomCode,
                        name: 'ë¯¸ë°°ì •',
                        status: 'ì •ìƒ',
                        date: '',
                        memo: '',
                        rowIndex: -1
                    });
                }
            }

            console.log(`${building}ë™ ${floor}ì¸µ í•™ìƒ ìˆ˜:`, students.length);
            return students;
        }

        // 3ì¸ì‹¤ í•™ìƒ ì°¾ê¸°
        function find3PersonRoomStudents(roomCode) {
            const students = [];
            const baseRoom = roomCode;
            
            // 3ì¸ì‹¤ ì…€ ë²”ìœ„ì—ì„œ í•´ë‹¹ í˜¸ì‹¤ê³¼ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  í•™ìƒ ì°¾ê¸°
            sheetsData.forEach((row, index) => {
                if (row[1] && row[1].startsWith(baseRoom)) {
                    students.push({
                        room: row[1],
                        name: row[2] || 'ë¯¸ë°°ì •',
                        status: row[3] || 'ì •ìƒ',
                        date: row[4] || '',
                        memo: row[5] || '',
                        sheetRow: row[0]
                    });
                }
            });

            return students;
        }

        // í•™ìƒ ëª©ë¡ í‘œì‹œ
        function displayStudents(students) {
            const studentsGrid = document.getElementById('students-grid');
            const studentsSection = document.getElementById('students-section');
            const selectedInfo = document.getElementById('selected-info');
            
            const building = document.getElementById('building-select').value;
            const floor = document.getElementById('floor-select').value;
            
            selectedInfo.textContent = `${building}ë™ ${floor}ì¸µ`;
            studentsSection.style.display = 'block';
            
            studentsGrid.innerHTML = '';
            currentStudents = students;

            students.forEach((student, index) => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <div class="room-number">${student.room}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="student-status">
                        <select onchange="updateStudentStatus(${index}, this.value)">
                            <option value="ì •ìƒ" ${student.status === 'ì •ìƒ' ? 'selected' : ''}>ì •ìƒ</option>
                            <option value="ì™¸ë°•" ${student.status === 'ì™¸ë°•' ? 'selected' : ''}>ì™¸ë°•</option>
                            <option value="ì‹ ê·œ" ${student.status === 'ì‹ ê·œ' ? 'selected' : ''}>ì‹ ê·œ</option>
                            <option value="ì´ë™-" ${student.status === 'ì´ë™-' ? 'selected' : ''}>ì´ë™-</option>
                            <option value="ì´ë™+" ${student.status === 'ì´ë™+' ? 'selected' : ''}>ì´ë™+</option>
                            <option value="ë“±ë¯¸" ${student.status === 'ë“±ë¯¸' ? 'selected' : ''}>ë“±ë¯¸</option>
                            <option value="í‡´ì†Œ" ${student.status === 'í‡´ì†Œ' ? 'selected' : ''}>í‡´ì†Œ</option>
                        </select>
                    </div>
                    <div class="student-memo">
                        <input type="text" value="${student.memo}" placeholder="ë¹„ê³ " onchange="updateStudentMemo(${index}, this.value)">
                    </div>
                `;
                studentsGrid.appendChild(studentCard);
            });

            // ìë™ ì§‘ê³„ ì—…ë°ì´íŠ¸
            updateStats();
        }

        // í•™ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStudentStatus(index, status) {
            currentStudents[index].status = status;
            updateStats();
        }

        // í•™ìƒ ë©”ëª¨ ì—…ë°ì´íŠ¸
        function updateStudentMemo(index, memo) {
            currentStudents[index].memo = memo;
        }

        // í†µê³„ ìë™ ì§‘ê³„
        function updateStats() {
            const stats = {
                current: 0,
                out: 0,
                new: 0,
                moveOut: 0,
                moveIn: 0,
                absent: 0,
                etc: 0
            };

            currentStudents.forEach(student => {
                if (student.name !== 'ë¯¸ë°°ì •') {
                    switch (student.status) {
                        case 'ì •ìƒ':
                            stats.current++;
                            break;
                        case 'ì™¸ë°•':
                            stats.out++;
                            break;
                        case 'ì‹ ê·œ':
                            stats.new++;
                            stats.current++;
                            break;
                        case 'ì´ë™-':
                            stats.moveOut++;
                            break;
                        case 'ì´ë™+':
                            stats.moveIn++;
                            stats.current++;
                            break;
                        case 'ë“±ë¯¸':
                            stats.absent++;
                            break;
                        case 'í‡´ì†Œ':
                            stats.etc++;
                            break;
                    }
                }
            });

            // í˜„ì¬ì› ê³„ì‚° (ì •ìƒ + ì‹ ê·œ + ì´ë™+ë§Œ í¬í•¨)
            stats.current = currentStudents.filter(s => 
                s.name !== 'ë¯¸ë°°ì •' && (s.status === 'ì •ìƒ' || s.status === 'ì‹ ê·œ' || s.status === 'ì´ë™+')
            ).length;

            document.getElementById('current-count').value = stats.current;
            document.getElementById('out-count').value = stats.out;
            document.getElementById('new-count').value = stats.new;
            document.getElementById('move-out-count').value = stats.moveOut;
            document.getElementById('move-in-count').value = stats.moveIn;
            document.getElementById('absent-count').value = stats.absent;
            document.getElementById('etc-count').value = stats.etc;
        }

        // ë³´ê³ ì„œ ì œì¶œ
        async function submitReport() {
            const manager = document.getElementById('manager-select').value;
            const building = document.getElementById('building-select').value;
            const floor = document.getElementById('floor-select').value;
            const isModification = document.getElementById('is-modification').checked;

            if (!manager || !building || !floor) {
                showMessage('ë‹´ë‹¹ì, ë™, ì¸µì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¤‘ë³µ ì œì¶œ ì²´í¬
            const reportKey = `${building}-${floor}`;
            const today = new Date().toDateString();
            const currentHour = new Date().getHours();
            
            if (!isModification && lastReportDate[reportKey] === today && currentHour < 22) {
                showMessage('ì´ë¯¸ ì˜¤ëŠ˜ ë³´ê³ ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ìˆ˜ì •ë³´ê³ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoading(true);

                // êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
                await updateGoogleSheets();

                // ì”ë”” ì›¹í›… ì „ì†¡
                await sendToJandi(manager, building, floor, isModification);

                // ì œì¶œ ì™„ë£Œ ì²˜ë¦¬
                lastReportDate[reportKey] = today;
                showMessage('ì¸ì›ë³´ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                showLoading(false);
            } catch (error) {
                console.error('ì œì¶œ ì‹¤íŒ¨:', error);
                showMessage('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                showLoading(false);
            }
        }

        // êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ (í–‰ ë²ˆí˜¸ ìˆ˜ì •)
        async function updateGoogleSheets() {
            try {
                // ì‹¤ì œ Apps Script ì›¹ì•± URL
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbxaXVyYcaOL-GYYkmqOKaWwubOSzKctrAwERV04fTPr5sBSPqsxGPhfVsuZqVOMw7d4vQ/exec';
                
                // ì—…ë°ì´íŠ¸í•  í•™ìƒ ë°ì´í„° ì¤€ë¹„
                const updates = [];
                
                currentStudents.forEach(student => {
                    if (student.name !== 'ë¯¸ë°°ì •' && student.sheetRow >= 0) {
                        // í–‰ ë²ˆí˜¸ ìˆ˜ì •: B3ì´ í—¤ë”, B4ë¶€í„° ë°ì´í„° ì‹œì‘
                        // student.sheetRowëŠ” CSVì—ì„œì˜ ì¸ë±ìŠ¤ (0=í—¤ë”, 1=ì²«ë²ˆì§¸ ë°ì´í„°í–‰)
                        // ì‹¤ì œ ì‹œíŠ¸ì—ì„œëŠ” B3=í—¤ë”, B4=ì²«ë²ˆì§¸ ë°ì´í„°í–‰
                        const actualSheetRow = student.sheetRow + 3; // í•œ ì¤„ ìœ„ë¡œ ìˆ˜ì •
                        
                        updates.push({
                            room: student.room,
                            status: student.status,
                            memo: student.memo,
                            rowIndex: sheetRow - 1 // Apps ScriptëŠ” 0-based ì¸ë±ìŠ¤ ì‚¬ìš©
                        });
                    }
                });

                if (updates.length === 0) {
                    console.log('ì—…ë°ì´íŠ¸í•  í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                console.log('Apps Scriptë¡œ ì „ì†¡í•  ë°ì´í„°:', updates);

                // Apps Script ì›¹ì•± í˜¸ì¶œ
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateStudents',
                        updates: updates
                    }),
                    mode: 'no-cors' // CORS ë¬¸ì œ í•´ê²°
                });

                // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
                console.log('Apps Script í˜¸ì¶œ ì™„ë£Œ (no-cors ëª¨ë“œ)');

                // ë¡œì»¬ ë°ì´í„° ë™ê¸°í™”
                currentStudents.forEach(student => {
                    if (student.sheetRow >= 0 && sheetsData[student.sheetRow + 1]) {
                        sheetsData[student.sheetRow + 1][3] = student.status; // Dì—´
                        sheetsData[student.sheetRow + 1][4] = new Date().toISOString().split('T')[0]; // Eì—´
                        sheetsData[student.sheetRow + 1][5] = student.memo; // Fì—´
                    }
                });

                console.log('êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ìš”ì²­ ì „ì†¡ ì™„ë£Œ');

            } catch (error) {
                console.error('êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                
                // ë°±ì—…: ì§ì ‘ API í˜¸ì¶œ ì‹œë„
                try {
                    await updateSheetsDirectly();
                } catch (directError) {
                    console.error('ì§ì ‘ API í˜¸ì¶œë„ ì‹¤íŒ¨:', directError);
                    
                    // ë¡œì»¬ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
                    currentStudents.forEach(student => {
                        if (student.sheetRow >= 0 && sheetsData[student.sheetRow + 1]) {
                            sheetsData[student.sheetRow + 1][3] = student.status;
                            sheetsData[student.sheetRow + 1][5] = student.memo;
                        }
                    });
                    
                    showMessage('êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ë¡œì»¬ ë°ì´í„°ëŠ” ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ë°±ì—…ìš© ì§ì ‘ API í˜¸ì¶œ (í–‰ ë²ˆí˜¸ ìˆ˜ì •)
        async function updateSheetsDirectly() {
            const updates = [];
            
            currentStudents.forEach(student => {
                if (student.name !== 'ë¯¸ë°°ì •' && student.sheetRow >= 0) {
                    const actualSheetRow = student.sheetRow + 3; // í•œ ì¤„ ìœ„ë¡œ ìˆ˜ì •
                    
                    // Dì—´ (ìƒíƒœ) ì—…ë°ì´íŠ¸
                    updates.push({
                        range: `yulee!D${actualSheetRow}`,
                        values: [[student.status]]
                    });
                    
                    // Eì—´ (ë‚ ì§œ) ì—…ë°ì´íŠ¸
                    const today = new Date().toISOString().split('T')[0];
                    updates.push({
                        range: `yulee!E${actualSheetRow}`,
                        values: [[today]]
                    });
                    
                    // Fì—´ (ë©”ëª¨) ì—…ë°ì´íŠ¸
                    if (student.memo) {
                        updates.push({
                            range: `yulee!F${actualSheetRow}`,
                            values: [[student.memo]]
                        });
                    }
                }
            });

            if (updates.length > 0) {
                const batchUpdateUrl = `https://sheets.googleapis.com/v4/spreadsheets/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/values:batchUpdate?key=AIzaSyAAaDiNQC3o779j_4pzVC4ouuZr48Y-PbY`;
                
                const response = await fetch(batchUpdateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        valueInputOption: 'USER_ENTERED',
                        data: updates
                    })
                });

                if (response.ok) {
                    console.log('ì§ì ‘ API í˜¸ì¶œë¡œ ì—…ë°ì´íŠ¸ ì„±ê³µ');
                    showMessage('êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
                } else {
                    throw new Error('ì§ì ‘ API í˜¸ì¶œ ì‹¤íŒ¨');
                }
            }
        }

        // ì”ë”” ì›¹í›… ì „ì†¡
        async function sendToJandi(manager, building, floor, isModification) {
            const webhookUrl = 'https://wh.jandi.com/connect-api/webhook/29522216/3d9603c3b428b386c0d640758e236cb4';
            
            const stats = {
                current: parseInt(document.getElementById('current-count').value),
                out: parseInt(document.getElementById('out-count').value),
                new: parseInt(document.getElementById('new-count').value),
                moveOut: parseInt(document.getElementById('move-out-count').value),
                moveIn: parseInt(document.getElementById('move-in-count').value),
                absent: parseInt(document.getElementById('absent-count').value),
                etc: parseInt(document.getElementById('etc-count').value)
            };

            // íŠ¹ë³„ ìƒíƒœ í•™ìƒë“¤ ì •ë³´ ìˆ˜ì§‘
            const specialStudents = {
                ì™¸ë°•: currentStudents.filter(s => s.status === 'ì™¸ë°•' && s.name !== 'ë¯¸ë°°ì •'),
                ì‹ ê·œ: currentStudents.filter(s => s.status === 'ì‹ ê·œ' && s.name !== 'ë¯¸ë°°ì •'),
                'ì´ë™-': currentStudents.filter(s => s.status === 'ì´ë™-' && s.name !== 'ë¯¸ë°°ì •'),
                'ì´ë™+': currentStudents.filter(s => s.status === 'ì´ë™+' && s.name !== 'ë¯¸ë°°ì •'),
                ë“±ë¯¸: currentStudents.filter(s => s.status === 'ë“±ë¯¸' && s.name !== 'ë¯¸ë°°ì •'),
                í‡´ì†Œ: currentStudents.filter(s => s.status === 'í‡´ì†Œ' && s.name !== 'ë¯¸ë°°ì •')
            };

            let message = `${isModification ? 'ğŸ”„ ìˆ˜ì •ë³´ê³ ' : 'ğŸ“‹ ì¸ì›ë³´ê³ '}\n\n`;
            message += `ğŸ‘¤ ë‹´ë‹¹ì: ${manager}\n`;
            message += `ğŸ¢ ìœ„ì¹˜: ${building}ë™ ${floor}ì¸µ\n\n`;
            message += `ğŸ“Š ì¸ì› í˜„í™©\n`;
            message += `â€¢ í˜„ì¬ì›: ${stats.current}ëª…\n`;
            message += `â€¢ ì™¸ë°•: ${stats.out}ëª…\n`;
            message += `â€¢ ì‹ ê·œ: ${stats.new}ëª…\n`;
            message += `â€¢ ì´ë™-: ${stats.moveOut}ëª…\n`;
            message += `â€¢ ì´ë™+: ${stats.moveIn}ëª…\n`;
            message += `â€¢ ë“±ë¯¸: ${stats.absent}ëª…\n`;
            message += `â€¢ í‡´ì†Œ: ${stats.etc}ëª…\n\n`;

            // íŠ¹ë³„ ìƒíƒœ í•™ìƒ ìƒì„¸ ì •ë³´
            Object.keys(specialStudents).forEach(status => {
                if (specialStudents[status].length > 0) {
                    message += `ğŸ“ ${status} í•™ìƒ ëª©ë¡:\n`;
                    specialStudents[status].forEach(student => {
                        message += `   â€¢ ${student.room} ${student.name}`;
                        if (student.memo) {
                            message += ` (${student.memo})`;
                        }
                        message += '\n';
                    });
                    message += '\n';
                }
            });

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        body: message,
                        connectColor: isModification ? '#ff9500' : '#4f46e5'
                    })
                });

                if (!response.ok) {
                    throw new Error('ì”ë”” ì „ì†¡ ì‹¤íŒ¨');
                }

                console.log('ì”ë”” ì „ì†¡ ì™„ë£Œ');
            } catch (error) {
                console.error('ì”ë”” ì „ì†¡ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submit-btn').disabled = show;
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById('building-select').addEventListener('change', function() {
            const building = this.value;
            const floor = document.getElementById('floor-select').value;
            
            if (building && floor) {
                const students = getStudentsByFloor(building, floor);
                displayStudents(students);
            } else {
                document.getElementById('students-section').style.display = 'none';
            }
        });

        document.getElementById('floor-select').addEventListener('change', function() {
            const building = document.getElementById('building-select').value;
            const floor = this.value;
            
            if (building && floor) {
                const students = getStudentsByFloor(building, floor);
                displayStudents(students);
            } else {
                document.getElementById('students-section').style.display = 'none';
            }
        });

        // í†µê³„ ìˆ˜ë™ ì…ë ¥ ì´ë²¤íŠ¸
        ['current-count', 'out-count', 'new-count', 'move-out-count', 'move-in-count', 'absent-count', 'etc-count'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                // ìˆ˜ë™ ì…ë ¥ ì‹œ ìë™ ì§‘ê³„ ë¹„í™œì„±í™” í‘œì‹œ (ì„ íƒì‚¬í•­)
                console.log(`${id} ìˆ˜ë™ ë³€ê²½: ${this.value}`);
            });
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            loadSheetsData();
            
            // ì–´ì œ ë³´ê³  ë°ì´í„° ë³µì› (22ì‹œ ì´í›„)
            const currentHour = new Date().getHours();
            if (currentHour >= 22) {
                // localStorageì—ì„œ ì–´ì œ ë³´ê³  ë°ì´í„° ë³µì›
                const yesterdayData = localStorage.getItem('yesterdayReports');
                if (yesterdayData) {
                    lastReportDate = JSON.parse(yesterdayData);
                }
            }
        });

        // ë§¤ì¼ 22ì‹œì— ì–´ì œ ë°ì´í„° ì €ì¥
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 22 && now.getMinutes() === 0) {
                localStorage.setItem('yesterdayReports', JSON.stringify(lastReportDate));
            }
        }, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
    </script>
</body>
</html>
