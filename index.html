<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏∞ÏàôÏÇ¨ Ïù∏ÏõêÎ≥¥Í≥†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-card.current { border-left: 5px solid #10b981; }
        .stat-card.out { border-left: 5px solid #f59e0b; }
        .stat-card.new { border-left: 5px solid #3b82f6; }
        .stat-card.move-out { border-left: 5px solid #ef4444; }
        .stat-card.move-in { border-left: 5px solid #8b5cf6; }
        .stat-card.absent { border-left: 5px solid #6b7280; }
        .stat-card.etc { border-left: 5px solid #f97316; }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-card input {
            background: none;
            border: none;
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            width: 100%;
            outline: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-group select {
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
            outline: none;
        }

        .control-group select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .students-section {
            margin-top: 30px;
        }

        .students-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            border-radius: 10px;
        }

        .students-grid {
            display: grid;
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: 100px 1fr 150px 150px 1fr;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .room-number {
            font-weight: 700;
            font-size: 1.1rem;
            color: #4f46e5;
            text-align: center;
            padding: 8px;
            background: linear-gradient(135deg, #eef2ff, #e0e7ff);
            border-radius: 8px;
        }

        .student-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .student-status select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            outline: none;
            transition: all 0.3s ease;
        }

        .student-status select:focus {
            border-color: #4f46e5;
        }

        .student-memo input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
        }

        .student-memo input:focus {
            border-color: #4f46e5;
        }

        .submit-section {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 15px;
            text-align: center;
        }

        .submit-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }

            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }

            .student-card {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .students-grid {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Í∏∞ÏàôÏÇ¨ Ïù∏ÏõêÎ≥¥Í≥†</h1>
            <p>Ïã§ÏãúÍ∞Ñ Ïù∏Ïõê ÌòÑÌô© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</p>
        </div>

        <div class="main-content">
            <!-- Ïù∏Ïõê ÌòÑÌô© Ïπ¥Îìú -->
            <div class="stats-grid">
                <div class="stat-card current">
                    <h3>ÌòÑÏû¨Ïõê</h3>
                    <input type="number" id="current-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card out">
                    <h3>Ïô∏Î∞ï</h3>
                    <input type="number" id="out-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card new">
                    <h3>Ïã†Í∑ú</h3>
                    <input type="number" id="new-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card move-out">
                    <h3>Ïù¥Îèô-</h3>
                    <input type="number" id="move-out-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card move-in">
                    <h3>Ïù¥Îèô+</h3>
                    <input type="number" id="move-in-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card absent">
                    <h3>Îì±ÎØ∏</h3>
                    <input type="number" id="absent-count" class="number" value="0" min="0">
                </div>
                <div class="stat-card etc">
                    <h3>Ìá¥ÏÜå</h3>
                    <input type="number" id="etc-count" class="number" value="0" min="0">
                </div>
            </div>

            <!-- ÏÑ†ÌÉù Ïª®Ìä∏Î°§ -->
            <div class="controls">
                <div class="control-group">
                    <label>Îã¥ÎãπÏûê</label>
                    <select id="manager-select">
                        <option value="">Îã¥ÎãπÏûê ÏÑ†ÌÉù</option>
                        <option value="Ïù¥ÏòÅÏö¥">Ïù¥ÏòÅÏö¥</option>
                        <option value="ÍπÄÌòúÏ†ï">ÍπÄÌòúÏ†ï</option>
                        <option value="Ïù¥ÏãúÏö∞">Ïù¥ÏãúÏö∞</option>
                        <option value="Í≥†ÏäπÏôÑ">Í≥†ÏäπÏôÑ</option>
                        <option value="ÎÇ®Ïù∏Îã¨">ÎÇ®Ïù∏Îã¨</option>
                        <option value="Ï°∞ÏòÅÍ∂å">Ï°∞ÏòÅÍ∂å</option>
                        <option value="Ìô©ÎØºÏ≤†">Ìô©ÎØºÏ≤†</option>
                        <option value="ÍπÄÍ±¥Ìù¨">ÍπÄÍ±¥Ìù¨</option>
                        <option value="Í∞ïÏßÄÌõà">Í∞ïÏßÄÌõà</option>
                        <option value="ÏÜ°Ïù∏Ïàò">ÏÜ°Ïù∏Ïàò</option>
                        <option value="ÍπÄÏòÅÌòÑ">ÍπÄÏòÅÌòÑ</option>
                        <option value="Ïù¥ÏÉÅÎØº">Ïù¥ÏÉÅÎØº</option>
                        <option value="ÎÇòÏ†ïÏö∞">ÎÇòÏ†ïÏö∞</option>
                        <option value="ÌôçÏÑ±Î™®">ÌôçÏÑ±Î™®</option>
                        <option value="ÏßÑÏ†ïÌòÑ">ÏßÑÏ†ïÌòÑ</option>
                        <option value="ÏõêÌòÑÏ£º">ÏõêÌòÑÏ£º</option>
                        <option value="ÍπÄÏ†ïÏïÑ">ÍπÄÏ†ïÏïÑ</option>
                        <option value="ÍπÄÏßÄÌòÑ">ÍπÄÏßÄÌòÑ</option>
                        <option value="ÍπÄÎØ∏Í≤Ω">ÍπÄÎØ∏Í≤Ω</option>
                        <option value="Ïú†ÎÇòÍ≤Ω">Ïú†ÎÇòÍ≤Ω</option>
                        <option value="Ïã†Í∑ú1">Ïã†Í∑ú1</option>
                        <option value="Ïã†Í∑ú2">Ïã†Í∑ú2</option>
                        <option value="Ïã†Í∑ú3">Ïã†Í∑ú3</option>
                        <option value="Ïã†Í∑ú4">Ïã†Í∑ú4</option>
                        <option value="Ïã†Í∑ú5">Ïã†Í∑ú5</option>
                        <option value="Ïã†Í∑ú6">Ïã†Í∑ú6</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Îèô</label>
                    <select id="building-select">
                        <option value="">Îèô ÏÑ†ÌÉù</option>
                        <option value="A">AÎèô (ÎÇ®ÌïôÏÉù)</option>
                        <option value="B">BÎèô (ÎÇ®ÌïôÏÉù)</option>
                        <option value="C">CÎèô (ÎÇ®ÌïôÏÉù)</option>
                        <option value="D">DÎèô (Ïó¨ÌïôÏÉù)</option>
                        <option value="E">EÎèô (Ïó¨ÌïôÏÉù)</option>
                        <option value="F">FÎèô (ÎÇ®ÌïôÏÉù)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Ï∏µ</label>
                    <select id="floor-select">
                        <option value="">Ï∏µ ÏÑ†ÌÉù</option>
                        <option value="1">1Ï∏µ (1Ïù∏Ïã§)</option>
                        <option value="2">2Ï∏µ (1Ïù∏Ïã§)</option>
                        <option value="3">3Ï∏µ (1Ïù∏Ïã§)</option>
                        <option value="4">4Ï∏µ (3Ïù∏Ïã§)</option>
                    </select>
                </div>
            </div>

            <!-- ÌïôÏÉù Ï†ïÎ≥¥ ÏÑπÏÖò -->
            <div class="students-section" id="students-section" style="display: none;">
                <div class="students-header">
                    <h3>ÌïôÏÉù ÌòÑÌô©</h3>
                    <span id="selected-info"></span>
                </div>
                <div class="students-grid" id="students-grid">
                    <!-- ÌïôÏÉù Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            </div>

            <!-- Ï†úÏ∂ú ÏÑπÏÖò -->
            <div class="submit-section">
                <div class="submit-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-modification">
                        <label for="is-modification">ÏàòÏ†ïÎ≥¥Í≥†</label>
                    </div>
                </div>
                <button class="submit-btn" id="submit-btn" onclick="submitReport()">
                    üìã Ïù∏ÏõêÎ≥¥Í≥† Ï†úÏ∂ú
                </button>
            </div>

            <!-- Î°úÎî© Î∞è Î©îÏãúÏßÄ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Ï≤òÎ¶¨ Ï§ë...</p>
            </div>
            <div class="message" id="message"></div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let sheetsData = [];
        let currentStudents = [];
        let lastReportDate = {};

        // Í∏∞ÏàôÏÇ¨ Ìò∏Ïã§ Î≤îÏúÑ Ï†ïÏùò
        const dormitoryRanges = {
            'A': {
                '1': { start: 101, end: 160 },
                '2': { start: 201, end: 262 },
                '3': { start: 301, end: 362 },
                '4': { start: 401, end: 432 }
            },
            'B': {
                '1': { start: 101, end: 140 },
                '2': { start: 201, end: 241 },
                '3': { start: 301, end: 341 },
                '4': { start: 401, end: 421 }
            },
            'C': {
                '1': { start: 101, end: 161 },
                '2': { start: 201, end: 262 },
                '3': { start: 301, end: 362 },
                '4': { start: 401, end: 432 }
            },
            'D': {
                '1': { start: 101, end: 144 },
                '2': { start: 201, end: 245 },
                '3': { start: 301, end: 345 },
                '4': { start: 401, end: 423 }
            },
            'E': {
                '1': { start: 101, end: 176 },
                '2': { start: 201, end: 278 },
                '3': { start: 301, end: 378 },
                '4': { start: 401, end: 440 }
            },
            'F': {
                '1': { start: 101, end: 132 },
                '2': { start: 201, end: 233 },
                '3': { start: 301, end: 333 },
                '4': { start: 401, end: 417 }
            }
        };

        // Íµ¨Í∏Ä ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (B3Î∂ÄÌÑ∞ ÏãúÏûë)
        async function loadSheetsData() {
            try {
                showLoading(true);
                
                // B3:P1000 Î≤îÏúÑÎ°ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/values/yulee!B3:P1000?key=AIzaSyAAaDiNQC3o779j_4pzVC4ouuZr48Y-PbY`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('B3:P1000 Î≤îÏúÑÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                }
                
                // Îç∞Ïù¥ÌÑ∞ ÌòïÏãù Î≥ÄÌôò (Ïù∏Îç±Ïä§ Ïó¥ Ï∂îÍ∞Ä)
                sheetsData = [];
                
                // Ìó§Îçî (B3 Ìñâ)
                sheetsData.push(['Ïù∏Îç±Ïä§'].concat(data.values[0]));
                
                // Îç∞Ïù¥ÌÑ∞ (B4Î∂ÄÌÑ∞)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    if (row && row.length > 0) {
                        sheetsData.push([i + 3].concat(row)); // Ïã§Ï†ú ÏãúÌä∏ Ìñâ Î≤àÌò∏
                    }
                }
                
                console.log('ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', sheetsData.length, 'Ìñâ (Ìó§Îçî Ìè¨Ìï®)');
                showLoading(false);
                
            } catch (error) {
                console.error('ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                showMessage('ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ÏÑ†ÌÉùÎêú Îèô/Ï∏µÏùò ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        function getStudentsByFloor(building, floor) {
            if (!building || !floor || !dormitoryRanges[building] || !dormitoryRanges[building][floor]) {
                console.error('ÏûòÎ™ªÎêú Îèô/Ï∏µ ÏÑ†ÌÉù:', building, floor);
                return [];
            }

            console.log(`${building}Îèô ${floor}Ï∏µ ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...`);

            const range = dormitoryRanges[building][floor];
            const students = [];

            // Ìò∏Ïã§ Î≤îÏúÑ ÎÇ¥Ïùò Î™®Îì† Ìò∏Ïã§ Ï≤òÎ¶¨
            for (let roomNum = range.start; roomNum <= range.end; roomNum++) {
                const roomCode = `${building}${roomNum}`;
                
                // ÏãúÌä∏ÏóêÏÑú Ìï¥Îãπ Ìò∏Ïã§ Ï∞æÍ∏∞ (ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ ÏóÜÏù¥)
                const studentRows = sheetsData.filter((row, index) => {
                    if (index === 0) return false; // Ìó§Îçî Ï†úÏô∏
                    const sheetRoom = row[1] ? row[1].toString().toUpperCase() : '';
                    return sheetRoom === roomCode.toUpperCase();
                });

                if (studentRows.length > 0) {
                    // Ìï¥Îãπ Ìò∏Ïã§Ïùò Î™®Îì† ÌïôÏÉù Ï∂îÍ∞Ä (3Ïù∏Ïã§ ÎåÄÏùë)
                    studentRows.forEach(studentRow => {
                        const rowIndex = sheetsData.findIndex(r => r[0] === studentRow[0]);
                        students.push({
                            room: studentRow[1] || roomCode,
                            name: studentRow[2] || 'ÎØ∏Î∞∞Ï†ï',
                            status: studentRow[3] || 'Ï†ïÏÉÅ',
                            date: studentRow[4] || '',
                            memo: studentRow[5] || '',
                            sheetRow: sheetRow
                        });
                    });
                } else {
                    // ÏãúÌä∏Ïóê ÏóÜÎäî Ìò∏Ïã§ÏùÄ ÎØ∏Î∞∞Ï†ïÏúºÎ°ú Ï∂îÍ∞Ä
                    students.push({
                        room: roomCode,
                        name: 'ÎØ∏Î∞∞Ï†ï',
                        status: 'Ï†ïÏÉÅ',
                        date: '',
                        memo: '',
                        rowIndex: -1
                    });
                }
            }

            console.log(`${building}Îèô ${floor}Ï∏µ ÌïôÏÉù Ïàò:`, students.length);
            return students;
        }

        // 3Ïù∏Ïã§ ÌïôÏÉù Ï∞æÍ∏∞
        function find3PersonRoomStudents(roomCode) {
            const students = [];
            const baseRoom = roomCode;
            
            // 3Ïù∏Ïã§ ÏÖÄ Î≤îÏúÑÏóêÏÑú Ìï¥Îãπ Ìò∏Ïã§Í≥º ÏùºÏπòÌïòÎäî Î™®Îì† ÌïôÏÉù Ï∞æÍ∏∞
            sheetsData.forEach((row, index) => {
                if (row[1] && row[1].startsWith(baseRoom)) {
                    students.push({
                        room: row[1],
                        name: row[2] || 'ÎØ∏Î∞∞Ï†ï',
                        status: row[3] || 'Ï†ïÏÉÅ',
                        date: row[4] || '',
                        memo: row[5] || '',
                        sheetRow: row[0]
                    });
                }
            });

            return students;
        }

        // ÌïôÏÉù Î™©Î°ù ÌëúÏãú
        function displayStudents(students) {
            const studentsGrid = document.getElementById('students-grid');
            const studentsSection = document.getElementById('students-section');
            const selectedInfo = document.getElementById('selected-info');
            
            const building = document.getElementById('building-select').value;
            const floor = document.getElementById('floor-select').value;
            
            selectedInfo.textContent = `${building}Îèô ${floor}Ï∏µ`;
            studentsSection.style.display = 'block';
            
            studentsGrid.innerHTML = '';
            currentStudents = students;

            students.forEach((student, index) => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <div class="room-number">${student.room}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="student-status">
                        <select onchange="updateStudentStatus(${index}, this.value)">
                            <option value="Ï†ïÏÉÅ" ${student.status === 'Ï†ïÏÉÅ' ? 'selected' : ''}>Ï†ïÏÉÅ</option>
                            <option value="Ïô∏Î∞ï" ${student.status === 'Ïô∏Î∞ï' ? 'selected' : ''}>Ïô∏Î∞ï</option>
                            <option value="Ïã†Í∑ú" ${student.status === 'Ïã†Í∑ú' ? 'selected' : ''}>Ïã†Í∑ú</option>
                            <option value="Ïù¥Îèô-" ${student.status === 'Ïù¥Îèô-' ? 'selected' : ''}>Ïù¥Îèô-</option>
                            <option value="Ïù¥Îèô+" ${student.status === 'Ïù¥Îèô+' ? 'selected' : ''}>Ïù¥Îèô+</option>
                            <option value="Îì±ÎØ∏" ${student.status === 'Îì±ÎØ∏' ? 'selected' : ''}>Îì±ÎØ∏</option>
                            <option value="Ìá¥ÏÜå" ${student.status === 'Ìá¥ÏÜå' ? 'selected' : ''}>Ìá¥ÏÜå</option>
                        </select>
                    </div>
                    <div class="student-memo">
                        <input type="text" value="${student.memo}" placeholder="ÎπÑÍ≥†" onchange="updateStudentMemo(${index}, this.value)">
                    </div>
                `;
                studentsGrid.appendChild(studentCard);
            });

            // ÏûêÎèô ÏßëÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateStats();
        }

        // ÌïôÏÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudentStatus(index, status) {
            currentStudents[index].status = status;
            updateStats();
        }

        // ÌïôÏÉù Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudentMemo(index, memo) {
            currentStudents[index].memo = memo;
        }

        // ÌÜµÍ≥Ñ ÏûêÎèô ÏßëÍ≥Ñ
        function updateStats() {
            const stats = {
                current: 0,
                out: 0,
                new: 0,
                moveOut: 0,
                moveIn: 0,
                absent: 0,
                etc: 0
            };

            currentStudents.forEach(student => {
                if (student.name !== 'ÎØ∏Î∞∞Ï†ï') {
                    switch (student.status) {
                        case 'Ï†ïÏÉÅ':
                            stats.current++;
                            break;
                        case 'Ïô∏Î∞ï':
                            stats.out++;
                            break;
                        case 'Ïã†Í∑ú':
                            stats.new++;
                            stats.current++;
                            break;
                        case 'Ïù¥Îèô-':
                            stats.moveOut++;
                            break;
                        case 'Ïù¥Îèô+':
                            stats.moveIn++;
                            stats.current++;
                            break;
                        case 'Îì±ÎØ∏':
                            stats.absent++;
                            break;
                        case 'Ìá¥ÏÜå':
                            stats.etc++;
                            break;
                    }
                }
            });

            // ÌòÑÏû¨Ïõê Í≥ÑÏÇ∞ (Ï†ïÏÉÅ + Ïã†Í∑ú + Ïù¥Îèô+Îßå Ìè¨Ìï®)
            stats.current = currentStudents.filter(s => 
                s.name !== 'ÎØ∏Î∞∞Ï†ï' && (s.status === 'Ï†ïÏÉÅ' || s.status === 'Ïã†Í∑ú' || s.status === 'Ïù¥Îèô+')
            ).length;

            document.getElementById('current-count').value = stats.current;
            document.getElementById('out-count').value = stats.out;
            document.getElementById('new-count').value = stats.new;
            document.getElementById('move-out-count').value = stats.moveOut;
            document.getElementById('move-in-count').value = stats.moveIn;
            document.getElementById('absent-count').value = stats.absent;
            document.getElementById('etc-count').value = stats.etc;
        }

        // Î≥¥Í≥†ÏÑú Ï†úÏ∂ú
        async function submitReport() {
            const manager = document.getElementById('manager-select').value;
            const building = document.getElementById('building-select').value;
            const floor = document.getElementById('floor-select').value;
            const isModification = document.getElementById('is-modification').checked;

            if (!manager || !building || !floor) {
                showMessage('Îã¥ÎãπÏûê, Îèô, Ï∏µÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            // Ï§ëÎ≥µ Ï†úÏ∂ú Ï≤¥ÌÅ¨
            const reportKey = `${building}-${floor}`;
            const today = new Date().toDateString();
            const currentHour = new Date().getHours();
            
            if (!isModification && lastReportDate[reportKey] === today && currentHour < 22) {
                showMessage('Ïù¥ÎØ∏ Ïò§Îäò Î≥¥Í≥†Î•º ÏôÑÎ£åÌñàÏäµÎãàÎã§. ÏàòÏ†ïÎ≥¥Í≥†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            try {
                showLoading(true);

                // Íµ¨Í∏Ä ÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
                await updateGoogleSheets();

                // ÏûîÎîî ÏõπÌõÖ Ï†ÑÏÜ°
                await sendToJandi(manager, building, floor, isModification);

                // Ï†úÏ∂ú ÏôÑÎ£å Ï≤òÎ¶¨
                lastReportDate[reportKey] = today;
                showMessage('Ïù∏ÏõêÎ≥¥Í≥†Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†úÏ∂úÎêòÏóàÏäµÎãàÎã§.', 'success');
                
                showLoading(false);
            } catch (error) {
                console.error('Ï†úÏ∂ú Ïã§Ìå®:', error);
                showMessage('Ï†úÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                showLoading(false);
            }
        }

        // Íµ¨Í∏Ä ÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ (Ìñâ Î≤àÌò∏ ÏàòÏ†ï)
        async function updateGoogleSheets() {
            try {
                // Ïã§Ï†ú Apps Script ÏõπÏï± URL
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbxaXVyYcaOL-GYYkmqOKaWwubOSzKctrAwERV04fTPr5sBSPqsxGPhfVsuZqVOMw7d4vQ/exec';
                
                // ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                const updates = [];
                
                currentStudents.forEach(student => {
                    if (student.name !== 'ÎØ∏Î∞∞Ï†ï' && student.sheetRow >= 0) {
                        // Ìñâ Î≤àÌò∏ ÏàòÏ†ï: B3Ïù¥ Ìó§Îçî, B4Î∂ÄÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏãúÏûë
                        // student.sheetRowÎäî CSVÏóêÏÑúÏùò Ïù∏Îç±Ïä§ (0=Ìó§Îçî, 1=Ï≤´Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞Ìñâ)
                        // Ïã§Ï†ú ÏãúÌä∏ÏóêÏÑúÎäî B3=Ìó§Îçî, B4=Ï≤´Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞Ìñâ
                        const actualSheetRow = student.sheetRow + 3; // Ìïú Ï§Ñ ÏúÑÎ°ú ÏàòÏ†ï
                        
                        updates.push({
                            room: student.room,
                            status: student.status,
                            memo: student.memo,
                            rowIndex: sheetRow - 1 // Apps ScriptÎäî 0-based Ïù∏Îç±Ïä§ ÏÇ¨Ïö©
                        });
                    }
                });

                if (updates.length === 0) {
                    console.log('ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÌïôÏÉù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                console.log('Apps ScriptÎ°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞:', updates);

                // Apps Script ÏõπÏï± Ìò∏Ï∂ú
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateStudents',
                        updates: updates
                    }),
                    mode: 'no-cors' // CORS Î¨∏Ï†ú Ìï¥Í≤∞
                });

                // no-cors Î™®ÎìúÏóêÏÑúÎäî ÏùëÎãµÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏúºÎØÄÎ°ú ÏÑ±Í≥µÏúºÎ°ú Í∞ÑÏ£º
                console.log('Apps Script Ìò∏Ï∂ú ÏôÑÎ£å (no-cors Î™®Îìú)');

                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
                currentStudents.forEach(student => {
                    if (student.sheetRow >= 0 && sheetsData[student.sheetRow + 1]) {
                        sheetsData[student.sheetRow + 1][3] = student.status; // DÏó¥
                        sheetsData[student.sheetRow + 1][4] = new Date().toISOString().split('T')[0]; // EÏó¥
                        sheetsData[student.sheetRow + 1][5] = student.memo; // FÏó¥
                    }
                });

                console.log('Íµ¨Í∏Ä ÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠ Ï†ÑÏÜ° ÏôÑÎ£å');

            } catch (error) {
                console.error('Íµ¨Í∏ÄÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                
                // Î∞±ÏóÖ: ÏßÅÏ†ë API Ìò∏Ï∂ú ÏãúÎèÑ
                try {
                    await updateSheetsDirectly();
                } catch (directError) {
                    console.error('ÏßÅÏ†ë API Ìò∏Ï∂úÎèÑ Ïã§Ìå®:', directError);
                    
                    // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Îßå ÏóÖÎç∞Ïù¥Ìä∏
                    currentStudents.forEach(student => {
                        if (student.sheetRow >= 0 && sheetsData[student.sheetRow + 1]) {
                            sheetsData[student.sheetRow + 1][3] = student.status;
                            sheetsData[student.sheetRow + 1][5] = student.memo;
                        }
                    });
                    
                    showMessage('Íµ¨Í∏ÄÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏßÄÎßå Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Îäî Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'error');
                }
            }
        }

        // Î∞±ÏóÖÏö© ÏßÅÏ†ë API Ìò∏Ï∂ú (Ìñâ Î≤àÌò∏ ÏàòÏ†ï)
        async function updateSheetsDirectly() {
            const updates = [];
            
            currentStudents.forEach(student => {
                if (student.name !== 'ÎØ∏Î∞∞Ï†ï' && student.sheetRow >= 0) {
                    const actualSheetRow = student.sheetRow + 3; // Ìïú Ï§Ñ ÏúÑÎ°ú ÏàòÏ†ï
                    
                    // DÏó¥ (ÏÉÅÌÉú) ÏóÖÎç∞Ïù¥Ìä∏
                    updates.push({
                        range: `yulee!D${actualSheetRow}`,
                        values: [[student.status]]
                    });
                    
                    // EÏó¥ (ÎÇ†Ïßú) ÏóÖÎç∞Ïù¥Ìä∏
                    const today = new Date().toISOString().split('T')[0];
                    updates.push({
                        range: `yulee!E${actualSheetRow}`,
                        values: [[today]]
                    });
                    
                    // FÏó¥ (Î©îÎ™®) ÏóÖÎç∞Ïù¥Ìä∏
                    if (student.memo) {
                        updates.push({
                            range: `yulee!F${actualSheetRow}`,
                            values: [[student.memo]]
                        });
                    }
                }
            });

            if (updates.length > 0) {
                const batchUpdateUrl = `https://sheets.googleapis.com/v4/spreadsheets/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/values:batchUpdate?key=AIzaSyAAaDiNQC3o779j_4pzVC4ouuZr48Y-PbY`;
                
                const response = await fetch(batchUpdateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        valueInputOption: 'USER_ENTERED',
                        data: updates
                    })
                });

                if (response.ok) {
                    console.log('ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ');
                    showMessage('Íµ¨Í∏ÄÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å', 'success');
                } else {
                    throw new Error('ÏßÅÏ†ë API Ìò∏Ï∂ú Ïã§Ìå®');
                }
            }
        }

        // ÏûîÎîî ÏõπÌõÖ Ï†ÑÏÜ°
        async function sendToJandi(manager, building, floor, isModification) {
            const webhookUrl = 'https://wh.jandi.com/connect-api/webhook/29522216/3d9603c3b428b386c0d640758e236cb4';
            
            const stats = {
                current: parseInt(document.getElementById('current-count').value),
                out: parseInt(document.getElementById('out-count').value),
                new: parseInt(document.getElementById('new-count').value),
                moveOut: parseInt(document.getElementById('move-out-count').value),
                moveIn: parseInt(document.getElementById('move-in-count').value),
                absent: parseInt(document.getElementById('absent-count').value),
                etc: parseInt(document.getElementById('etc-count').value)
            };

            // ÌäπÎ≥Ñ ÏÉÅÌÉú ÌïôÏÉùÎì§ Ï†ïÎ≥¥ ÏàòÏßë
            const specialStudents = {
                Ïô∏Î∞ï: currentStudents.filter(s => s.status === 'Ïô∏Î∞ï' && s.name !== 'ÎØ∏Î∞∞Ï†ï'),
                Ïã†Í∑ú: currentStudents.filter(s => s.status === 'Ïã†Í∑ú' && s.name !== 'ÎØ∏Î∞∞Ï†ï'),
                'Ïù¥Îèô-': currentStudents.filter(s => s.status === 'Ïù¥Îèô-' && s.name !== 'ÎØ∏Î∞∞Ï†ï'),
                'Ïù¥Îèô+': currentStudents.filter(s => s.status === 'Ïù¥Îèô+' && s.name !== 'ÎØ∏Î∞∞Ï†ï'),
                Îì±ÎØ∏: currentStudents.filter(s => s.status === 'Îì±ÎØ∏' && s.name !== 'ÎØ∏Î∞∞Ï†ï'),
                Ìá¥ÏÜå: currentStudents.filter(s => s.status === 'Ìá¥ÏÜå' && s.name !== 'ÎØ∏Î∞∞Ï†ï')
            };

            let message = `${isModification ? 'üîÑ ÏàòÏ†ïÎ≥¥Í≥†' : 'üìã Ïù∏ÏõêÎ≥¥Í≥†'}\n\n`;
            message += `üë§ Îã¥ÎãπÏûê: ${manager}\n`;
            message += `üè¢ ÏúÑÏπò: ${building}Îèô ${floor}Ï∏µ\n\n`;
            message += `üìä Ïù∏Ïõê ÌòÑÌô©\n`;
            message += `‚Ä¢ ÌòÑÏû¨Ïõê: ${stats.current}Î™Ö\n`;
            message += `‚Ä¢ Ïô∏Î∞ï: ${stats.out}Î™Ö\n`;
            message += `‚Ä¢ Ïã†Í∑ú: ${stats.new}Î™Ö\n`;
            message += `‚Ä¢ Ïù¥Îèô-: ${stats.moveOut}Î™Ö\n`;
            message += `‚Ä¢ Ïù¥Îèô+: ${stats.moveIn}Î™Ö\n`;
            message += `‚Ä¢ Îì±ÎØ∏: ${stats.absent}Î™Ö\n`;
            message += `‚Ä¢ Ìá¥ÏÜå: ${stats.etc}Î™Ö\n\n`;

            // ÌäπÎ≥Ñ ÏÉÅÌÉú ÌïôÏÉù ÏÉÅÏÑ∏ Ï†ïÎ≥¥
            Object.keys(specialStudents).forEach(status => {
                if (specialStudents[status].length > 0) {
                    message += `üìù ${status} ÌïôÏÉù Î™©Î°ù:\n`;
                    specialStudents[status].forEach(student => {
                        message += `   ‚Ä¢ ${student.room} ${student.name}`;
                        if (student.memo) {
                            message += ` (${student.memo})`;
                        }
                        message += '\n';
                    });
                    message += '\n';
                }
            });

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        body: message,
                        connectColor: isModification ? '#ff9500' : '#4f46e5'
                    })
                });

                if (!response.ok) {
                    throw new Error('ÏûîÎîî Ï†ÑÏÜ° Ïã§Ìå®');
                }

                console.log('ÏûîÎîî Ï†ÑÏÜ° ÏôÑÎ£å');
            } catch (error) {
                console.error('ÏûîÎîî Ï†ÑÏÜ° Ïò§Î•ò:', error);
                throw error;
            }
        }

        // Î°úÎî© ÌëúÏãú/Ïà®ÍπÄ
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submit-btn').disabled = show;
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        document.getElementById('building-select').addEventListener('change', function() {
            const building = this.value;
            const floor = document.getElementById('floor-select').value;
            
            if (building && floor) {
                const students = getStudentsByFloor(building, floor);
                displayStudents(students);
            } else {
                document.getElementById('students-section').style.display = 'none';
            }
        });

        document.getElementById('floor-select').addEventListener('change', function() {
            const building = document.getElementById('building-select').value;
            const floor = this.value;
            
            if (building && floor) {
                const students = getStudentsByFloor(building, floor);
                displayStudents(students);
            } else {
                document.getElementById('students-section').style.display = 'none';
            }
        });

        // ÌÜµÍ≥Ñ ÏàòÎèô ÏûÖÎ†• Ïù¥Î≤§Ìä∏
        ['current-count', 'out-count', 'new-count', 'move-out-count', 'move-in-count', 'absent-count', 'etc-count'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                // ÏàòÎèô ÏûÖÎ†• Ïãú ÏûêÎèô ÏßëÍ≥Ñ ÎπÑÌôúÏÑ±Ìôî ÌëúÏãú (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                console.log(`${id} ÏàòÎèô Î≥ÄÍ≤Ω: ${this.value}`);
            });
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', function() {
            loadSheetsData();
            
            // Ïñ¥Ï†ú Î≥¥Í≥† Îç∞Ïù¥ÌÑ∞ Î≥µÏõê (22Ïãú Ïù¥ÌõÑ)
            const currentHour = new Date().getHours();
            if (currentHour >= 22) {
                // localStorageÏóêÏÑú Ïñ¥Ï†ú Î≥¥Í≥† Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                const yesterdayData = localStorage.getItem('yesterdayReports');
                if (yesterdayData) {
                    lastReportDate = JSON.parse(yesterdayData);
                }
            }
        });

        // Îß§Ïùº 22ÏãúÏóê Ïñ¥Ï†ú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 22 && now.getMinutes() === 0) {
                localStorage.setItem('yesterdayReports', JSON.stringify(lastReportDate));
            }
        }, 60000); // 1Î∂ÑÎßàÎã§ Ï≤¥ÌÅ¨
    </script>
</body>
</html>
